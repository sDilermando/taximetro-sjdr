<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Tax√≠metro Digital</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  background:#0c0f14;
  font-family: "Segoe UI", Arial, sans-serif;
  color:#eaeaea;
}
header{
  background:#111726;
  text-align:center;
  padding:14px;
  font-size:20px;
  letter-spacing:1px;
}
.container{
  max-width:600px;
  margin:auto;
  padding:12px;
}
.panel{
  background:#151c2e;
  border-radius:14px;
  padding:15px;
  margin-bottom:12px;
}
.display{
  font-size:34px;
  text-align:center;
  font-weight:bold;
  color:#00f5a0;
}
.info{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-top:8px;
}
button{
  width:100%;
  padding:14px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
  font-weight:bold;
}
.start{background:#00f5a0;}
.pause{background:#2c3558;color:#fff;}
.stop{background:#ff3b3b;color:#fff;}
.config input, .config select{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:none;
  background:#1e2640;
  color:#fff;
}
label{font-size:13px;}
.row{
  display:flex;
  gap:8px;
}
#map{height:260px;border-radius:12px;}
.small{font-size:12px;opacity:.8;text-align:center;}
</style>
</head>

<body>

<header>üöï TAX√çMETRO DIGITAL</header>

<div class="container">

<div class="panel">
  <div class="display">R$ <span id="valor">0.00</span></div>
  <div class="info">
    <span>Dist: <span id="dist">0.00</span> km</span>
    <span>Tempo: <span id="tempo">0</span> min</span>
    <span>Bandeira <span id="bandeira">1</span></span>
  </div>
</div>

<div class="panel row">
  <button class="start" onclick="iniciar()">INICIAR</button>
  <button class="pause" onclick="pausar()">PAUSAR</button>
  <button class="stop" onclick="encerrar()">ENCERRAR</button>
</div>

<div class="panel config">
<h3>Configura√ß√£o</h3>

<label>Bandeirada (R$)</label>
<input id="banderada" type="number" step="0.01">

<label>B1 ‚Äì R$/km</label>
<input id="b1_km" type="number" step="0.01">

<label>B1 ‚Äì R$/min</label>
<input id="b1_min" type="number" step="0.01">

<label>B2 ‚Äì R$/km</label>
<input id="b2_km" type="number" step="0.01">

<label>B2 ‚Äì R$/min</label>
<input id="b2_min" type="number" step="0.01">

<label>Bandeira 2</label>
<select id="modoB2">
  <option value="auto">Autom√°tica (22h‚Äì6h)</option>
  <option value="manual">Manual</option>
</select>

<button onclick="salvar()">Salvar</button>
</div>

<div class="panel">
<h3>Destino & Pr√©via</h3>
<input id="destino" placeholder="Pesquisar destino">
<button onclick="buscar()">Buscar</button>
<div id="map"></div>
<div class="small">Estimativa: R$ <span id="previa">0.00</span></div>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let cfg={
  banderada:5,
  b1_km:2.5,b1_min:0.5,
  b2_km:3.5,b2_min:0.7
};

let rodando=false, pausado=false;
let inicio, ultimo;
let dist=0, valor=0;
let latA, lonA;
let map, mark;

function salvar(){
  cfg={
    banderada:+banderada.value,
    b1_km:+b1_km.value,b1_min:+b1_min.value,
    b2_km:+b2_km.value,b2_min:+b2_min.value
  };
  localStorage.setItem("cfgTaxi",JSON.stringify(cfg));
  alert("Configura√ß√£o salva");
}

(function carregar(){
  let d=localStorage.getItem("cfgTaxi");
  if(d)cfg=JSON.parse(d);
  banderada.value=cfg.banderada;
  b1_km.value=cfg.b1_km;
  b1_min.value=cfg.b1_min;
  b2_km.value=cfg.b2_km;
  b2_min.value=cfg.b2_min;
})();

function bandeira(){
  if(modoB2.value==="manual")return 2;
  let h=new Date().getHours();
  return(h>=22||h<6)?2:1;
}

function iniciar(){
  if(rodando)return;
  rodando=true; pausado=false;
  inicio=Date.now(); ultimo=inicio;
  valor=cfg.banderada;
  navigator.geolocation.watchPosition(p=>{
    if(!rodando||pausado)return;
    let {latitude,longitude}=p.coords;
    if(latA){
      dist+=calc(latA,lonA,latitude,longitude);
    }
    latA=latitude; lonA=longitude;
  });
}

function pausar(){pausado=!pausado;}

function encerrar(){
  rodando=false; pausado=false;
  latA=null;
  alert("Total da corrida: R$ "+valor.toFixed(2));
}

setInterval(()=>{
  if(!rodando||pausado)return;
  let agora=Date.now();
  let min=(agora-ultimo)/60000;
  ultimo=agora;

  let b=bandeira();
  bandeiraEl.textContent=b;

  if(dist>1.5){
    let vkm=(b==1?cfg.b1_km:cfg.b2_km)*min*0.5;
    let vmin=(b==1?cfg.b1_min:cfg.b2_min)*min;
    valor+=Math.max(vkm,vmin);
  }

  valorEl();
},3000);

function valorEl(){
  valor.textContent=valor.toFixed(2);
  distEl.textContent=dist.toFixed(2);
  tempo.textContent=Math.floor((Date.now()-inicio)/60000);
}

function calc(a,b,c,d){
  const R=6371;
  let dLat=(c-a)*Math.PI/180;
  let dLon=(d-b)*Math.PI/180;
  let x=Math.sin(dLat/2)**2+
  Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
  Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// MAPA
try{
  map=L.map('map').setView([-21.13,-44.26],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}catch{}

async function buscar(){
  if(!navigator.onLine)return;
  let q=destino.value;
  let r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
  let j=await r.json();
  if(!j[0])return;
  let lat=j[0].lat, lon=j[0].lon;
  if(mark)mark.remove();
  mark=L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],14);
}
</script>

</body>
</html>
