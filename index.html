<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tax√≠metro GPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --neons: #00ff88; --dark: #111; --gray: #222; }
        body { background: var(--dark); color: white; font-family: 'Roboto', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER CONFIG */
        .config-bar { background: var(--gray); padding: 15px; display: flex; gap: 10px; border-bottom: 1px solid #333; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 5px; }
        .input-conf { width: 100%; background: #000; border: 1px solid #444; color: var(--neons); padding: 8px; border-radius: 5px; font-weight: bold; text-align: center; font-size: 1rem; }

        /* MOSTRADOR */
        .display-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .label-total { font-size: 1rem; color: #888; text-transform: uppercase; letter-spacing: 2px; }
        .value-total { font-size: 5rem; font-weight: 900; color: white; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .info-row { display: flex; gap: 30px; margin-top: 20px; }
        .info-box { text-align: center; }
        .info-val { font-size: 1.5rem; font-weight: 700; color: #ccc; }
        .info-lbl { font-size: 0.7rem; color: #666; }

        /* STATUS */
        .status-badge { background: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 20px; color: #888; }
        .running { background: rgba(0, 255, 136, 0.2); color: var(--neons); border: 1px solid var(--neons); }

        /* CONTROLES */
        .controls { padding: 20px; display: flex; gap: 10px; background: var(--gray); }
        .btn { flex: 1; padding: 20px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-start { background: var(--neons); color: black; }
        .btn-stop { background: #ff3333; color: white; display: none; }
        .btn-reset { background: #444; color: white; }

        /* ANIMA√á√ÉO PULSO */
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .gps-dot { width: 10px; height: 10px; background: red; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .gps-active { background: var(--neons); animation: pulse 1s infinite; }
    </style>
</head>
<body>

    <div class="config-bar">
        <div class="input-group">
            <label>BANDEIRADA (R$)</label>
            <input type="number" id="base-price" class="input-conf" value="5.00">
        </div>
        <div class="input-group">
            <label>PRE√áO/KM (R$)</label>
            <input type="number" id="km-price" class="input-conf" value="2.50">
        </div>
    </div>

    <div class="display-area">
        <div id="gps-status" class="status-badge"><span class="gps-dot"></span> AGUARDANDO GPS</div>
        
        <div class="label-total">Valor a Pagar</div>
        <div class="value-total">R$ <span id="display-money">0.00</span></div>

        <div class="info-row">
            <div class="info-box">
                <div class="info-val"><span id="display-dist">0.0</span> km</div>
                <div class="info-lbl">DIST√ÇNCIA</div>
            </div>
            <div class="info-box">
                <div class="info-val" id="display-time">00:00</div>
                <div class="info-lbl">DURA√á√ÉO</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-reset" onclick="resetRide()"><i class="fas fa-trash"></i></button>
        <button class="btn btn-start" id="btn-start" onclick="toggleRide()">INICIAR</button>
        <button class="btn btn-stop" id="btn-stop" onclick="toggleRide()">PARAR</button>
    </div>

    <script>
        let running = false;
        let watchId = null;
        let startTime = null;
        let timerInterval = null;
        
        let totalDist = 0;
        let lastLat = null;
        let lastLng = null;
        let priceTotal = 0;

        // Configura GPS
        navigator.geolocation.watchPosition((p) => {
            const dot = document.querySelector('.gps-dot');
            dot.classList.add('gps-active');
            dot.style.background = '#00ff88';
            document.getElementById('gps-status').innerHTML = '<span class="gps-dot gps-active"></span> GPS CONECTADO';
        }, (err) => {
            console.error(err);
        }, { enableHighAccuracy: true });

        function toggleRide() {
            if(!running) {
                // INICIAR
                const base = parseFloat(document.getElementById('base-price').value);
                if(!base) return Swal.fire('Erro', 'Configure a bandeirada.', 'error');

                running = true;
                startTime = Date.now();
                priceTotal = base;
                
                // Trava inputs
                document.querySelectorAll('.input-conf').forEach(i => i.disabled = true);
                
                // UI
                document.getElementById('btn-start').style.display = 'none';
                document.getElementById('btn-stop').style.display = 'block';
                document.getElementById('display-money').innerText = base.toFixed(2);
                document.querySelector('.value-total').style.color = '#00ff88';

                // Timer
                timerInterval = setInterval(updateTime, 1000);

                // GPS Tracking
                if (navigator.geolocation) {
                    watchId = navigator.geolocation.watchPosition(processPosition, null, {
                        enableHighAccuracy: true,
                        maximumAge: 1000,
                        timeout: 5000
                    });
                }

            } else {
                // PARAR
                running = false;
                clearInterval(timerInterval);
                navigator.geolocation.clearWatch(watchId);
                lastLat = null; lastLng = null;

                // UI
                document.getElementById('btn-start').style.display = 'block';
                document.getElementById('btn-stop').style.display = 'none';
                document.getElementById('btn-start').innerText = 'CONTINUAR';
                document.querySelector('.value-total').style.color = 'white';
                
                // Finalizar
                checkout();
            }
        }

        function processPosition(position) {
            if (!running) return;

            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Ignora sinal ruim (>20m erro)
            if (accuracy > 20) return;

            if (lastLat != null) {
                const km = getDistanceFromLatLonInKm(lastLat, lastLng, lat, lng);
                
                // Filtro de ru√≠do (s√≥ conta se moveu > 5 metros)
                if (km > 0.005) {
                    totalDist += km;
                    updateCost();
                    lastLat = lat;
                    lastLng = lng;
                }
            } else {
                lastLat = lat;
                lastLng = lng;
            }
        }

        function updateCost() {
            const kmPrice = parseFloat(document.getElementById('km-price').value);
            const basePrice = parseFloat(document.getElementById('base-price').value);
            
            // C√°lculo: Bandeirada + (Km * Pre√ßo/Km)
            priceTotal = basePrice + (totalDist * kmPrice);
            
            document.getElementById('display-money').innerText = priceTotal.toFixed(2);
            document.getElementById('display-dist').innerText = totalDist.toFixed(1);
        }

        function updateTime() {
            const diff = Date.now() - startTime;
            const sec = Math.floor((diff / 1000) % 60);
            const min = Math.floor((diff / (1000 * 60)) % 60);
            const hrs = Math.floor((diff / (1000 * 60 * 60)));
            
            document.getElementById('display-time').innerText = 
                `${hrs > 0 ? hrs+':' : ''}${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function resetRide() {
            if(running) return;
            totalDist = 0;
            priceTotal = 0;
            startTime = null;
            lastLat = null; lastLng = null;
            
            document.getElementById('display-money').innerText = "0.00";
            document.getElementById('display-dist').innerText = "0.0";
            document.getElementById('display-time').innerText = "00:00";
            document.getElementById('btn-start').innerText = "INICIAR";
            document.querySelectorAll('.input-conf').forEach(i => i.disabled = false);
        }

        function checkout() {
            Swal.fire({
                title: 'Corrida Finalizada',
                html: `
                    Total: <b>R$ ${priceTotal.toFixed(2)}</b><br>
                    Dist√¢ncia: ${totalDist.toFixed(1)} km
                `,
                icon: 'success',
                confirmButtonText: '<i class="fab fa-whatsapp"></i> Enviar Cobran√ßa',
                confirmButtonColor: '#25D366',
                showCancelButton: true,
                cancelButtonText: 'Fechar'
            }).then((res) => {
                if(res.isConfirmed) {
                    const msg = `üöñ *RESUMO DA CORRIDA*%0A%0Aüí∞ Valor: R$ ${priceTotal.toFixed(2)}%0Aüìè Dist√¢ncia: ${totalDist.toFixed(1)} km%0A‚è±Ô∏è Tempo: ${document.getElementById('display-time').innerText}`;
                    window.open(`https://wa.me/?text=${msg}`, '_blank');
                }
            });
        }

        // Haversine Formula (C√°lculo Preciso de Dist√¢ncia)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1); 
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }

        function deg2rad(deg) { return deg * (Math.PI/180); }
    </script>
</body>
</html>
