<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tax√≠metro Pro 6.0</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #FFD700;
            --dark-bg: #000000;
            --panel-bg: rgba(20, 20, 20, 0.98);
            --success: #25D366;
            --warning: #ff9900;
            --flag2-color: #00b7ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--dark-bg);
            font-family: 'Montserrat', sans-serif;
            width: 100vw; 
            height: 100dvh; /* Altura din√¢mica real do mobile */
            overflow: hidden; 
            display: flex; 
            flex-direction: column; /* Organiza: Topo -> Meio -> Fim */
            color: white;
        }

        /* --- 1. HEADER (TOPO FIXO) --- */
        .header-container {
            flex: 0 0 auto; /* N√£o encolhe */
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 1px solid #333;
            padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 50;
            height: 60px;
        }

        .header-left { display: flex; flex-direction: column; justify-content: center; }
        .app-title { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 0.8rem; color: var(--gold); letter-spacing: 1px; }
        .app-info { font-size: 0.65rem; color: #888; }

        /* Barra de Ferramentas Ajustada */
        .toolbar { display: flex; gap: 8px; align-items: center; }
        .tool-btn {
            width: 38px; height: 38px; 
            background: #111; border: 1px solid #333;
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; fill: #ccc;
        }
        .tool-btn svg { width: 18px; height: 18px; }
        .tool-btn:active { background: var(--gold); border-color: var(--gold); fill: #000; }
        .tool-btn.whatsapp { fill: var(--success); border-color: #1a4d2e; }

        /* --- 2. √ÅREA CENTRAL (Flex√≠vel) --- */
        .content-area {
            flex: 1; /* Ocupa todo o espa√ßo que sobra */
            display: flex;
            justify-content: center; /* Centraliza Horizontalmente */
            align-items: center;     /* Centraliza Verticalmente */
            position: relative;
            padding: 20px;
        }

        /* --- CART√ÉO PRINCIPAL --- */
        .main-card {
            width: 100%; max-width: 360px; /* Largura m√°xima */
            background: var(--panel-bg);
            border: 1px solid #333; border-radius: 25px;
            padding: 25px 20px; text-align: center;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.05);
            position: relative;
            transition: border-color 0.3s;
        }
        
        /* Ajuste para telas muito pequenas (iPhone SE, etc) */
        @media (max-height: 600px) {
            .main-card { padding: 15px 10px; }
            .big-price { font-size: 3rem !important; margin: 0 !important; }
            .stats-row { margin: 15px 0 !important; }
        }

        .main-card.flag1 { border-color: var(--gold); }
        .main-card.flag1::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background:var(--gold); box-shadow: 0 0 15px var(--gold); }
        .main-card.flag2 { border-color: var(--flag2-color); }
        .main-card.flag2::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background:var(--flag2-color); box-shadow: 0 0 15px var(--flag2-color); }

        .status-tag {
            display: inline-block; background: #000; color: #666;
            padding: 4px 12px; border-radius: 15px; font-size: 0.7rem;
            text-transform: uppercase; font-weight: bold; margin-bottom: 10px;
            border: 1px solid #333;
        }
        .status-tag.running { color: var(--success); border-color: var(--success); background: rgba(37, 211, 102, 0.1); }
        .status-tag.paused { color: var(--warning); border-color: var(--warning); }

        /* Switch Bandeira */
        .flag-switch-container { display: flex; justify-content: center; margin-bottom: 5px; }
        .flag-switch { background: #222; border-radius: 20px; padding: 3px; display: flex; border: 1px solid #444; position: relative; }
        .flag-option { padding: 5px 15px; font-size: 0.7rem; font-weight: bold; color: #666; cursor: pointer; z-index: 2; transition: 0.3s; }
        .flag-option.active { color: #000; }
        .switch-bg { position: absolute; top: 3px; left: 3px; width: 50%; height: calc(100% - 6px); border-radius: 17px; transition: 0.3s; z-index: 1; }
        .flag-switch[data-state="1"] .switch-bg { left: 3px; background: var(--gold); }
        .flag-switch[data-state="2"] .switch-bg { left: 50%; background: var(--flag2-color); }
        .auto-badge { font-size: 0.6rem; color: var(--success); margin-left: 5px; display: none; align-items: center;}

        .big-price {
            font-family: 'Orbitron', sans-serif; font-size: 3.5rem; font-weight: 700;
            color: white; margin: 10px 0; line-height: 1;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        .main-card.flag1 .big-price { color: var(--gold); text-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .main-card.flag2 .big-price { color: var(--flag2-color); text-shadow: 0 0 20px rgba(0, 183, 255, 0.2); }
        .currency-symbol { font-size: 1.5rem; vertical-align: super; color: #fff; opacity: 0.5; }

        .stats-row { display: flex; justify-content: center; gap: 20px; margin: 25px 0 35px 0; padding-top: 20px; border-top: 1px solid #333; }
        .stat-item { display: flex; flex-direction: column; width: 80px; }
        .stat-val { font-family: 'Orbitron'; font-size: 1.1rem; color: white; font-weight: bold; }
        .stat-lbl { font-size: 0.6rem; color: #666; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .controls-row { display: flex; gap: 10px; width: 100%; }
        .btn-main { background: linear-gradient(135deg, #FFD700, #FDB931); color: black; border: none; padding: 18px 0; border-radius: 15px; font-family: 'Montserrat', sans-serif; font-size: 1rem; font-weight: 800; text-transform: uppercase; cursor: pointer; flex-grow: 1; box-shadow: 0 5px 20px rgba(255, 215, 0, 0.15); transition: 0.2s; }
        .btn-main:active { transform: scale(0.97); }
        .btn-main.stop { background: linear-gradient(135deg, #ff4444, #cc0000); color: white; box-shadow: 0 5px 20px rgba(255, 68, 68, 0.2); }
        .btn-pause { width: 54px; border-radius: 15px; background: #222; border: 1px solid #333; color: white; font-size: 1.2rem; display: none; justify-content: center; align-items: center; cursor: pointer; }
        .btn-pause.active { background: var(--warning); color: black; border-color: var(--warning); }

        /* --- MAPA TELA CHEIA --- */
        .map-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 60; display: none; flex-direction: column; }
        .map-screen.active { display: flex; }
        .map-controls-bar { padding: 15px; background: white; border-bottom: 1px solid #ddd; display: flex; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-light { flex-grow: 1; padding: 12px; background: #f5f5f5; border: 1px solid #ddd; color: #333; border-radius: 8px; font-family: 'Montserrat'; }
        .map-frame { flex-grow: 1; width: 100%; height: 100%; position: relative; background: #eee; }
        #visibleMap { width: 100%; height: 100%; }
        .estimate-card { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; display: none; color: #333; font-weight: bold; border: 2px solid var(--gold); white-space: nowrap;}

        /* MODAIS GERAIS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .overlay.active { display: flex; }
        .modal-box { background: #151515; border: 1px solid #333; padding: 20px; border-radius: 20px; width: 100%; max-width: 320px; text-align: center; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; color: #666; font-size: 1.5rem; cursor: pointer; line-height: 1; }
        .btn-full { width: 100%; padding: 15px; background: var(--gold); border: none; border-radius: 10px; font-weight: 800; cursor: pointer; color: black; margin-top: 15px; }
        .input-dark { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #333; color: white; border-radius: 8px; text-align: center; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .tab { flex: 1; padding: 8px; font-size: 0.7rem; background: #222; color: #888; border-radius: 5px; cursor: pointer; }
        .tab.active { background: var(--gold); color: black; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .checkbox-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 15px 0; color: #ccc; font-size: 0.9rem; }

    </style>
</head>
<body>

    <div id="map" style="display:none;"></div>

    <div class="header-container">
        <div class="header-left">
            <div class="app-title">TAX√çMETRO PRO</div>
            <div class="app-info"><span id="clock">--:--</span> ‚Ä¢ <span id="temp">26¬∞C</span></div>
        </div>
        
        <div class="toolbar">
            <div class="tool-btn" onclick="openHistory()" title="Relat√≥rio"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>
            <div class="tool-btn" onclick="openMapScreen()" title="Mapa"><svg viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg></div>
            <div class="tool-btn whatsapp" onclick="openWhatsApp()" title="WhatsApp"><svg viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01C17.18 3.03 14.69 2 12.04 2zM12.05 19.98c-1.48 0-2.93-.4-4.21-1.15l-.3-.18-3.11.82.83-3.04-.19-.31c-.82-1.33-1.26-2.87-1.26-4.46 0-4.66 3.79-8.45 8.45-8.45 2.26 0 4.38.88 5.98 2.48 1.6 1.6 2.48 3.72 2.48 5.98 0 4.66-3.79 8.45-8.45 8.45h-.22z"/></svg></div>
            <div class="tool-btn" onclick="openSettings()" title="Config"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
            <div class="tool-btn" onclick="openAdmin()" title="Admin" style="fill:#ff4444; border-color:rgba(255,68,68,0.3)"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg></div>
        </div>
    </div>

    <div class="content-area">
        <div class="main-card flag1" id="mainCard">
            
            <div class="status-tag" id="statusTag">LIVRE</div>

            <div class="flag-switch-container">
                <div class="flag-switch" id="flagSwitch" data-state="1" onclick="toggleFlagManual()">
                    <div class="switch-bg"></div>
                    <div class="flag-option active" id="opt1">BAND 1</div>
                    <div class="flag-option" id="opt2">BAND 2</div>
                </div>
                <div class="auto-badge" id="autoBadge">ü§ñ AUTO</div>
            </div>

            <div class="big-price">
                <span class="currency-symbol">R$</span> <span id="mainPrice">0,00</span>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-val" id="mainDist">0.0 km</span>
                    <span class="stat-lbl">Dist√¢ncia</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="mainTime">00:00</span>
                    <span class="stat-lbl">Tempo</span>
                </div>
            </div>

            <div class="controls-row">
                <button class="btn-pause" id="btnPause" onclick="togglePause()">‚è∏</button>
                <button class="btn-main" id="btnMain" onclick="toggleRide()">INICIAR CORRIDA</button>
            </div>
        </div>
    </div>

    <div id="mapScreen" class="map-screen">
        <div class="map-controls-bar">
            <input type="text" id="destInput" class="input-light" placeholder="Endere√ßo de destino...">
            <button class="tool-btn" style="background:var(--gold); color:black;" onclick="calculateEstimate()">IR</button>
            <button class="tool-btn" style="background:#333; color:white;" onclick="closeMapScreen()">‚úï</button>
        </div>
        <div id="estimateCard" class="estimate-card"></div>
        <div class="map-frame"><div id="visibleMap"></div></div>
    </div>

    <div id="settingsModal" class="overlay">
        <div class="modal-box">
            <div class="close-btn" onclick="closeModal('settingsModal')">√ó</div>
            <h3 style="color:var(--gold);">CONFIGURA√á√ïES</h3>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('tab1', this)">BAND 1</div>
                <div class="tab" onclick="switchTab('tab2', this)">BAND 2</div>
                <div class="tab" onclick="switchTab('tabAuto', this)">AUTO</div>
            </div>
            <div id="tab1" class="tab-content active">
                <label style="color:#aaa; font-size:0.8rem;">Bandeirada (R$)</label><input type="number" id="basePrice1" class="input-dark" value="5.00">
                <label style="color:#aaa; font-size:0.8rem;">Pre√ßo/KM (>1.5km)</label><input type="number" id="kmPrice1" class="input-dark" value="2.50">
                <label style="color:#aaa; font-size:0.8rem;">Pre√ßo/Hora</label><input type="number" id="hourPrice1" class="input-dark" value="24.00">
            </div>
            <div id="tab2" class="tab-content">
                <label style="color:#00b7ff; font-size:0.8rem;">Bandeirada (R$)</label><input type="number" id="basePrice2" class="input-dark" value="6.00">
                <label style="color:#00b7ff; font-size:0.8rem;">Pre√ßo/KM (>1.5km)</label><input type="number" id="kmPrice2" class="input-dark" value="3.00">
                <label style="color:#00b7ff; font-size:0.8rem;">Pre√ßo/Hora</label><input type="number" id="hourPrice2" class="input-dark" value="30.00">
            </div>
            <div id="tabAuto" class="tab-content">
                <div class="checkbox-row"><input type="checkbox" id="autoFlagCheck" style="transform:scale(1.5);"><span>Ativar troca autom√°tica</span></div>
                <label style="color:#aaa; font-size:0.8rem;">In√≠cio Band 2</label><input type="number" id="autoStart" class="input-dark" value="22">
                <label style="color:#aaa; font-size:0.8rem;">Fim Band 2</label><input type="number" id="autoEnd" class="input-dark" value="6">
            </div>
            <button class="btn-full" onclick="saveSettings()">SALVAR E FECHAR</button>
        </div>
    </div>

    <div id="receiptModal" class="overlay">
        <div class="modal-box">
            <h2 style="color:white; font-family:'Orbitron'; margin-top:0;">RESUMO</h2>
            <div style="background:#000; padding:20px; border-radius:10px; border:1px solid #333; margin:20px 0;">
                <span style="font-size:0.8rem; color:#888;">TOTAL A PAGAR</span>
                <strong id="recTotal" style="font-size:2.8rem; color:var(--gold); display:block; font-family:'Orbitron'">R$ 0,00</strong>
            </div>
            <div style="display:flex; justify-content:space-between; color:#ccc; font-size:0.9rem;">
                <span>Dist: <b id="recDist" style="color:white">0 km</b></span><span>Tempo: <b id="recTime" style="color:white">00:00</b></span>
            </div>
            <button class="btn-full" style="background:var(--success); color:white;" onclick="shareRide()">COMPARTILHAR üì≤</button>
            <button class="btn-full" style="background:#333;" onclick="closeReceipt()">NOVA CORRIDA</button>
        </div>
    </div>

    <div id="historyModal" class="overlay">
        <div class="modal-box">
            <div class="close-btn" onclick="closeModal('historyModal')">√ó</div>
            <h3 style="color:var(--gold);">HIST√ìRICO</h3>
            <div id="historyList" style="margin-top:15px; text-align:left; max-height:300px; overflow-y:auto;"></div>
            <button class="btn-full" style="background:#cc0000; font-size:0.8rem;" onclick="clearHistory()">LIMPAR</button>
        </div>
    </div>

    <div id="registerModal" class="overlay">
        <div class="modal-box">
            <h3 style="color:var(--gold);">BEM-VINDO</h3>
            <input type="text" id="regName" class="input-dark" placeholder="Nome do Motorista">
            <button class="btn-full" onclick="registerDriver()">INICIAR SISTEMA</button>
        </div>
    </div>

    <div id="adminModal" class="overlay">
        <div class="modal-box">
            <div class="close-btn" onclick="closeModal('adminModal')">√ó</div>
            <h3 style="color:#ff4444;">ADMINISTRATIVO</h3>
            <input type="password" id="adminPass" class="input-dark" placeholder="Senha">
            <button class="btn-full" onclick="checkAdmin()">ACESSAR</button>
            <div id="adminPanel" style="display:none; margin-top:15px; text-align:left; color:#ccc; font-size:0.85rem; background:#222; padding:10px; border-radius:10px;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- DADOS GLOBAIS ---
        let driverInfo = { name: '', id: '000' };
        let rideHistory = [];
        let currentFlag = 1; 
        let config = {
            f1: { base: 5.0, km: 2.5, hour: 24.0 },
            f2: { base: 6.0, km: 3.0, hour: 30.0 },
            auto: { active: false, start: 22, end: 6 }
        };

        function initApp() {
            const data = localStorage.getItem('sjdr_taxi_driver');
            if (data) driverInfo = JSON.parse(data); else document.getElementById('registerModal').classList.add('active');
            const hist = localStorage.getItem('sjdr_taxi_history');
            if (hist) rideHistory = JSON.parse(hist);
            const cfg = localStorage.getItem('sjdr_taxi_config');
            if (cfg) config = JSON.parse(cfg);
            
            fillConfigInputs();
            updateClock();
        }

        function fillConfigInputs() {
            document.getElementById('basePrice1').value = config.f1.base;
            document.getElementById('kmPrice1').value = config.f1.km;
            document.getElementById('hourPrice1').value = config.f1.hour;
            document.getElementById('basePrice2').value = config.f2.base;
            document.getElementById('kmPrice2').value = config.f2.km;
            document.getElementById('hourPrice2').value = config.f2.hour;
            document.getElementById('autoFlagCheck').checked = config.auto.active;
            document.getElementById('autoStart').value = config.auto.start;
            document.getElementById('autoEnd').value = config.auto.end;
        }

        function registerDriver() {
            const name = document.getElementById('regName').value;
            if(!name) return alert("Nome necess√°rio");
            driverInfo = { name, id: Math.floor(Math.random()*900)+100 };
            localStorage.setItem('sjdr_taxi_driver', JSON.stringify(driverInfo));
            document.getElementById('registerModal').classList.remove('active');
        }

        function saveSettings() {
            config.f1.base = parseFloat(document.getElementById('basePrice1').value);
            config.f1.km = parseFloat(document.getElementById('kmPrice1').value);
            config.f1.hour = parseFloat(document.getElementById('hourPrice1').value);
            config.f2.base = parseFloat(document.getElementById('basePrice2').value);
            config.f2.km = parseFloat(document.getElementById('kmPrice2').value);
            config.f2.hour = parseFloat(document.getElementById('hourPrice2').value);
            config.auto.active = document.getElementById('autoFlagCheck').checked;
            config.auto.start = parseInt(document.getElementById('autoStart').value);
            config.auto.end = parseInt(document.getElementById('autoEnd').value);
            localStorage.setItem('sjdr_taxi_config', JSON.stringify(config));
            closeModal('settingsModal');
            checkAutoFlag();
        }

        // --- MAPA ---
        let mapVisible, routeControl;
        function initMaps() {
            mapVisible = L.map('visibleMap', {zoomControl: false}).setView([-21.135, -44.261], 15);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(mapVisible);
        }
        function openMapScreen() {
            document.getElementById('mapScreen').classList.add('active');
            setTimeout(() => { 
                mapVisible.invalidateSize(); 
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        mapVisible.setView([pos.coords.latitude, pos.coords.longitude], 16);
                        L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(mapVisible);
                    });
                }
            }, 200);
        }
        function closeMapScreen() {
            document.getElementById('mapScreen').classList.remove('active');
            if(routeControl) { mapVisible.removeControl(routeControl); routeControl = null; }
            document.getElementById('estimateCard').style.display='none';
            document.getElementById('destInput').value='';
        }
        function calculateEstimate() {
            const query = document.getElementById('destInput').value;
            if(!query) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(r => r.json()).then(data => {
                    if(!data.length) return alert("Endere√ßo n√£o encontrado");
                    const dest = L.latLng(data[0].lat, data[0].lon);
                    navigator.geolocation.getCurrentPosition(pos => {
                        const start = L.latLng(pos.coords.latitude, pos.coords.longitude);
                        if(routeControl) mapVisible.removeControl(routeControl);
                        routeControl = L.Routing.control({
                            waypoints: [start, dest],
                            lineOptions: { styles: [{color: '#007BFF', weight: 6}] },
                            createMarker: function() { return null; },
                            show: false
                        }).on('routesfound', function(e) {
                            const route = e.routes[0];
                            const d = route.summary.totalDistance / 1000;
                            const t = route.summary.totalTime / 60;
                            const rates = currentFlag === 1 ? config.f1 : config.f2;
                            let total = 0;
                            if(d < 1.5) total = rates.base;
                            else total = rates.base + ((d-1.5)*rates.km) + ((t/60)*rates.hour);
                            const card = document.getElementById('estimateCard');
                            card.style.display='block';
                            card.innerHTML = `Estimativa: <span style="color:#007BFF">${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</span> (${d.toFixed(1)}km)`;
                        }).addTo(mapVisible);
                    });
                });
        }

        // --- TAX√çMETRO ---
        let isRunning = false, isPaused = false;
        let watchId = null, intervalId = null;
        let totalDistance = 0, startTime = 0;
        let lastLat = 0, lastLng = 0;

        function checkAutoFlag() {
            const badge = document.getElementById('autoBadge');
            if (config.auto.active) {
                badge.style.display = 'flex';
                const h = new Date().getHours();
                const s = config.auto.start; const e = config.auto.end;
                let isF2 = (s > e) ? (h >= s || h < e) : (h >= s && h < e);
                if (isF2 && currentFlag !== 2) setFlag(2);
                if (!isF2 && currentFlag !== 1) setFlag(1);
            } else { badge.style.display = 'none'; }
        }

        function toggleFlagManual() {
            if (config.auto.active) return alert("Modo Auto Ativo (Desative em Config)");
            setFlag(currentFlag === 1 ? 2 : 1);
        }

        function setFlag(f) {
            currentFlag = f;
            document.getElementById('flagSwitch').setAttribute('data-state', f);
            const card = document.getElementById('mainCard');
            if(f===1) { card.classList.add('flag1'); card.classList.remove('flag2'); document.getElementById('opt1').classList.add('active'); document.getElementById('opt2').classList.remove('active');}
            else { card.classList.add('flag2'); card.classList.remove('flag1'); document.getElementById('opt2').classList.add('active'); document.getElementById('opt1').classList.remove('active');}
        }

        function toggleRide() {
            const btn = document.getElementById('btnMain');
            if (!isRunning) {
                isRunning = true; isPaused = false;
                btn.innerText = "ENCERRAR"; btn.classList.add('stop');
                document.getElementById('btnPause').style.display = 'flex';
                document.getElementById('statusTag').innerText = "EM CORRIDA"; document.getElementById('statusTag').className = "status-tag running";
                totalDistance = 0; startTime = Date.now(); lastLat = 0;
                updateScreen(0,0,0);
                if (navigator.geolocation) watchId = navigator.geolocation.watchPosition(updatePos, null, {enableHighAccuracy:true});
                intervalId = setInterval(updateCalc, 1000);
            } else {
                isRunning = false;
                if(watchId) navigator.geolocation.clearWatch(watchId);
                if(intervalId) clearInterval(intervalId);
                showReceipt();
                btn.innerText = "INICIAR CORRIDA"; btn.classList.remove('stop');
                document.getElementById('btnPause').style.display = 'none';
                document.getElementById('statusTag').innerText = "LIVRE"; document.getElementById('statusTag').className = "status-tag";
            }
        }

        function togglePause() {
            if(!isRunning) return; isPaused = !isPaused;
            const btn = document.getElementById('btnPause'); const tag = document.getElementById('statusTag');
            if(isPaused) { btn.classList.add('active'); btn.innerText = "‚ñ∂"; tag.className = "status-tag paused"; }
            else { btn.classList.remove('active'); btn.innerText = "‚è∏"; tag.className = "status-tag running"; }
        }

        function updatePos(pos) {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            if(lastLat === 0) { lastLat = lat; lastLng = lng; return; }
            const R = 6371; 
            const d = R * (2 * Math.atan2(Math.sqrt(Math.sin((lat-lastLat)*Math.PI/180/2)**2 + Math.cos(lastLat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lng-lastLng)*Math.PI/180/2)**2), Math.sqrt(1-(Math.sin((lat-lastLat)*Math.PI/180/2)**2 + Math.cos(lastLat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lng-lastLng)*Math.PI/180/2)**2))));
            if(d > 0.005 && !isPaused) { totalDistance += d; lastLat = lat; lastLng = lng; }
        }

        function updateCalc() {
            if(isPaused) return;
            const rates = currentFlag === 1 ? config.f1 : config.f2;
            const ms = Date.now() - startTime; const hrs = ms / 3600000;
            let total = 0;
            if (totalDistance < 1.5) total = rates.base;
            else total = rates.base + ((totalDistance - 1.5) * rates.km) + (hrs * rates.hour);
            updateScreen(total, totalDistance, ms);
        }

        function updateScreen(p, d, ms) {
            document.getElementById('mainPrice').innerText = p.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('mainDist').innerText = d.toFixed(2) + ' km';
            const s=Math.floor((ms/1000)%60); const m=Math.floor((ms/60000)%60); const h=Math.floor(ms/3600000);
            document.getElementById('mainTime').innerText = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function showReceipt() {
            const p = document.getElementById('mainPrice').innerText;
            document.getElementById('recTotal').innerText = "R$ " + p;
            document.getElementById('recDist').innerText = document.getElementById('mainDist').innerText;
            document.getElementById('recTime').innerText = document.getElementById('mainTime').innerText;
            document.getElementById('receiptModal').classList.add('active');
            
            const ride = { date: new Date().toLocaleTimeString(), val: parseFloat(p.replace('.','').replace(',','.')) };
            rideHistory.push(ride); localStorage.setItem('sjdr_taxi_history', JSON.stringify(rideHistory));
        }

        // --- UTIL ---
        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}); checkAutoFlag(); }
        setInterval(updateClock, 1000);
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function openWhatsApp() { window.open(`https://wa.me/`, '_blank'); }
        function shareApp() { if(navigator.share) navigator.share({title:'Tax√≠metro Virtual', url:window.location.href}); else alert("Link copiado!"); }
        function closeReceipt() { closeModal('receiptModal'); updateScreen(0,0,0); }
        function shareRide() { navigator.share({text: `T√°xi R$ ${document.getElementById('recTotal').innerText}`}); }
        function switchTab(id, el) { 
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
            el.classList.add('active'); document.getElementById(id).classList.add('active'); 
        }
        function openHistory() {
            document.getElementById('historyModal').classList.add('active');
            const l = document.getElementById('historyList'); l.innerHTML = ''; let t = 0;
            rideHistory.forEach(r => { t += r.val; l.innerHTML += `<div style="background:#222;padding:10px;margin-bottom:5px;display:flex;justify-content:space-between;border-left:3px solid gold;color:white;"><span>${r.date}</span><span>R$ ${r.val.toFixed(2).replace('.',',')}</span></div>`; });
        }
        function openAdmin() { document.getElementById('adminModal').classList.add('active'); document.getElementById('adminPass').value=''; document.getElementById('adminPanel').style.display='none'; }
        function checkAdmin() {
            if(document.getElementById('adminPass').value==='1234') {
                document.getElementById('adminPanel').style.display='block';
                document.getElementById('adminPanel').innerHTML = `Motorista: <b style="color:white">${driverInfo.name}</b><br>ID: ${driverInfo.id}`;
            } else alert('Senha errada');
        }
        function clearHistory() { if(confirm("Limpar?")) { rideHistory=[]; localStorage.removeItem('sjdr_taxi_history'); openHistory(); } }

        initApp(); initMaps();
    </script>
</body>
</html>
